# deploys to production when a release is published
name: Deploy to Production
on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
    # Build job
    build:
        runs-on: ubuntu-latest
        environment: prod
        concurrency:
          group: ${{github.workflow}} - ${{github.ref}}

        env:
          DART_SASS_VERSION: 1.97.3
          GO_VERSION: 1.25.6
          HUGO_VERSION: 0.155.0
          NODE_VERSION: 24.13.0
          TZ: Europe/Oslo

        steps:
          - name: Checkout
            uses: actions/checkout@v4
            with:
              submodules: recursive
              fetch-depth: 0
             
          - name: Install Node.js dependencies
            run: '[[ -f package-lock.json || -f npm-shrinkwrap.json ]] && npm ci || true'

          - name: Install Dart Sass
            run: |
              curl -sLJO "https://github.com/sass/dart-sass/releases/download/${DART_SASS_VERSION}/dart-sass-${DART_SASS_VERSION}-linux-x64.tar.gz"
              tar -C "${HOME}/.local" -xf "dart-sass-${DART_SASS_VERSION}-linux-x64.tar.gz"
              rm "dart-sass-${DART_SASS_VERSION}-linux-x64.tar.gz"
              echo "${HOME}/.local/dart-sass" >> "${GITHUB_PATH}"        

          - name: Setup Hugo
            uses: peaceiris/actions-hugo@v3
            with:
              hugo-version: 'latest'
              extended: true              

          - name: Verify installations
            run: |
              echo "Dart Sass: $(sass --version)"
              echo "Go: $(go version)"
              echo "Hugo: $(hugo version)"
              echo "Node.js: $(node --version)"              

          - name: Build
            run: hugo --gc --minify

          - name: Upload public dir
            uses: actions/upload-artifact@v4
            with:
              name: public-artifact
              path: ./public

    # Deploy job
    deploy:
        runs-on: ubuntu-latest
        needs: build
        environment: prod

        steps:

            - name: Download public dir
              uses: actions/download-artifact@v4
              with:
                name: public-artifact
                path: public

            - name: Set globals
              id: globals
              shell: bash
              run: |
                echo "${{ secrets.SSH_USER }}" >> "${GITHUB_OUTPUT}"
                echo "${{ secrets.SSH_HOST }}" >> "${GITHUB_OUTPUT}"

            - name: Configure SSH
              run: |
                mkdir -p ~/.ssh/
                echo "${{ secrets.SSH_KEY }}" > ~/.ssh/webhost.key
                chmod 600 ~/.ssh/webhost.key
                cat >>~/.ssh/config <<END
                Host webhost
                  HostName ${{ steps.globals.outputs.SSH_HOST }}
                  User ${{ steps.globals.outputs.SSH_USER }}
                  IdentityFile ~/.ssh/webhost.key
                  StrictHostKeyChecking no
                END

            - name: rsync public dir make sure to delete old files
              run: rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no -l ${{ steps.globals.outputs.SSH_USER }}" ./public/ ${{ steps.globals.outputs.SSH_HOST }}:${{ vars.WEB_PATH }}/
